name: Deploy to Kubernetes

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install kubectl
        run: |
          curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Set up Kubernetes config
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}  # Store your kubeconfig in GitHub secrets
        run: |
          echo "${KUBECONFIG}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Install Ingress NGINX Controller
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml

      - name: Deploy application
        run: |
          kubectl apply -f kubernetes/vpro-app/  # Apply all YAML files in the directory

      - name: Show all services
        run: |
          kubectl get svc --all-namespaces

      - name: Show deployments
        run: |
          kubectl get deploy --all-namespaces

      - name: Show ingress endpoint
        run: |
          kubectl get ingress vpro-ingress

      - name: Port Forwarding
        run: |
          nohup kubectl port-forward svc/my-app 8080:8080 --address=0.0.0.0 &
